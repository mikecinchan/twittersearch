<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>X (Twitter) Advanced Search Link Builder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --blue:#1DA1F2; }
    body {
      font-family: Arial, sans-serif;
      max-width: 780px;
      margin: 32px auto;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 12px;
      background: #fafafa;
    }
    h2 { text-align: center; margin-top: 0; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 14px; }
    label { font-weight: bold; }
    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #fff;
      box-sizing: border-box;
    }
    textarea { min-height: 90px; resize: vertical; }
    small { color:#666; display:block; margin-top:6px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .btn {
      padding: 12px 16px;
      background: var(--blue);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
    .btn.secondary { background: #555; }
    .btn.danger { background: #b00020; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    #result {
      margin-top: 16px;
      padding: 12px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      word-break: break-all;
    }
    #result a { color: var(--blue); font-weight: bold; text-decoration: none; }
    #result a:hover { text-decoration: underline; }
    .card {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: #fff;
    }
    .muted { color:#777; font-size: 12px; }
    .hide { display: none; }
    .right { text-align: right; }
  </style>
</head>
<body>
  <h2>X Search Link Generator</h2>

  <!-- ---------- AUTH UI ---------- -->
  <div id="authView" class="card">
    <label for="email">Email</label>
    <input id="email" type="email" placeholder="your@email.com" />
    <label for="password">Password</label>
    <input id="password" type="password" placeholder="••••••••" />
    <div class="row">
      <button id="signInBtn" class="btn">Sign In</button>
      <button id="signOutBtn" class="btn secondary" disabled>Sign Out</button>
    </div>
    <small id="authMsg" class="muted"></small>
  </div>

  <!-- ---------- APP UI (hidden until signed in) ---------- -->
  <div id="appView" class="hide">
    <div class="right muted" style="margin-bottom:8px;">
      Signed in as <span id="whoami"></span>
    </div>

    <div class="grid">
      <!-- Keywords -->
      <div class="card">
        <label for="keywords">Keyword(s) (optional)</label>
        <input type="text" id="keywords" placeholder="e.g. robotic, 'ai robot', autonomy" />
        <small>
          Tips: single word (<code>robotic</code>), phrase with spaces (<code>"ai robot"</code>),
          or multiple terms separated by commas (we’ll build <code>(term1 OR term2)</code>).
        </small>
      </div>

      <!-- Account picker and input -->
      <div class="card">
        <div class="row">
          <div>
            <label for="accountSelect">Saved Accounts</label>
            <select id="accountSelect">
              <option value="">— Select from saved —</option>
            </select>
            <small class="muted">Choose a saved handle to fill the username box.</small>
          </div>
          <div>
            <label for="username">Twitter Username (without @)</label>
            <input type="text" id="username" placeholder="e.g. 0xdetweiler" />
            <small class="muted">You can type/paste here or pick from the saved list.</small>
          </div>
        </div>

        <div class="row">
          <button id="addAccount" class="btn">Add Username to Saved</button>
          <button id="removeSelected" class="btn secondary" disabled>Remove Selected</button>
        </div>
        <button id="clearAll" class="btn danger" disabled>Clear All Saved Accounts</button>
        <small class="muted">Saved in **Firestore** under your user.</small>
      </div>

      <!-- Import list -->
      <div class="card">
        <label for="importBox">Import List of Usernames</label>
        <textarea id="importBox" placeholder="@alice, bob
charlie_d
@Eve123"></textarea>
        <small>
          Paste handles separated by commas or new lines. “@” is optional. Invalid handles are skipped.
        </small>
        <div class="row">
          <button id="importBtn" class="btn">Import Names</button>
          <button id="exportBtn" class="btn secondary" disabled>Export Saved (CSV)</button>
        </div>
      </div>

      <!-- Dates -->
      <div class="row">
        <div class="card">
          <label for="startDate">Start Date</label>
          <input type="date" id="startDate" />
        </div>
        <div class="card">
          <label for="endDate">End Date</label>
          <input type="date" id="endDate" />
        </div>
      </div>

      <!-- Build -->
      <button id="build" class="btn">Generate Search Link</button>
    </div>

    <div id="result"></div>
  </div>

  <!-- Firebase SDKs (Compat API for simplicity in one file) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
   
    const firebaseConfig = {
      apiKey: "AIzaSyDBEsrU-6-BAbI3Kvy6BgLFz79H9EZVGBI",
      authDomain: "twittersearch-53f72.firebaseapp.com",
      projectId: "twittersearch-53f72",
      storageBucket: "twittersearch-53f72.firebasestorage.app",
      messagingSenderId: "64872289359",
      appId: "1:64872289359:web:91e39591964727a1e6863a"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Path design: users/{uid}/handles/{handle}
    function handlesColRef(uid) {
      return db.collection("users").doc(uid).collection("handles");
    }

    // --------- HELPERS ---------
    const HANDLE_RE = /^[A-Za-z0-9_]{1,15}$/; // X/Twitter handle rules
    const $ = (id) => document.getElementById(id);
    const normalizeHandle = (h) => {
      if (!h) return "";
      let s = h.trim();
      if (s.startsWith("@")) s = s.slice(1);
      s = s.replace(/\s+/g, "");
      return s.toLowerCase();
    };

    function uiEnableSavedActions(hasAny) {
      $("removeSelected").disabled = !hasAny;
      $("clearAll").disabled = !hasAny;
      $("exportBtn").disabled = !hasAny;
    }

    function renderAccounts(list) {
      const sel = $("accountSelect");
      sel.innerHTML = '<option value="">— Select from saved —</option>';
      list.forEach(h => {
        const opt = document.createElement("option");
        opt.value = h;
        opt.textContent = h;
        sel.appendChild(opt);
      });
      uiEnableSavedActions(list.length > 0);
    }

    // --------- AUTH STATE ---------
    let currentUser = null;
    let cachedList = []; // in-memory copy of Firestore list

    auth.onAuthStateChanged(async (user) => {
      currentUser = user;
      $("authMsg").textContent = "";
      if (user) {
        $("authView").classList.add("hide");
        $("appView").classList.remove("hide");
        $("signOutBtn").disabled = false;
        $("whoami").textContent = user.email || user.uid;
        await refreshList();
      } else {
        $("authView").classList.remove("hide");
        $("appView").classList.add("hide");
        $("signOutBtn").disabled = true;
      }
    });

    // --------- AUTH HANDLERS ---------
    $("signInBtn").addEventListener("click", async () => {
      const email = $("email").value.trim();
      const pass = $("password").value;
      $("authMsg").textContent = "Signing in...";
      try {
        await auth.signInWithEmailAndPassword(email, pass);
        $("authMsg").textContent = "Signed in.";
      } catch (e) {
        $("authMsg").textContent = e.message;
      }
    });

    $("signOutBtn").addEventListener("click", async () => {
      try {
        await auth.signOut();
      } catch (e) {
        alert(e.message);
      }
    });

    // --------- FIRESTORE CRUD ---------
    async function refreshList() {
      if (!currentUser) return;
      const snap = await handlesColRef(currentUser.uid).orderBy("handle").get();
      cachedList = snap.docs.map(d => d.id);
      renderAccounts(cachedList);
    }

    async function addHandle(h) {
      if (!currentUser) return;
      const handle = normalizeHandle(h);
      if (!handle) { alert("Please enter a username."); return; }
      if (!HANDLE_RE.test(handle)) { alert(`Invalid handle: ${handle}`); return; }
      await handlesColRef(currentUser.uid).doc(handle).set({
        handle,
        addedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
      await refreshList();
    }

    async function removeSelected() {
      if (!currentUser) return;
      const sel = $("accountSelect");
      const value = sel.value;
      if (!value) { alert("Select a saved account to remove."); return; }
      await handlesColRef(currentUser.uid).doc(value).delete();
      if ($("username").value.trim().toLowerCase() === value) {
        $("username").value = "";
      }
      await refreshList();
    }

    async function clearAll() {
      if (!currentUser) return;
      if (!confirm("Remove all saved accounts?")) return;
      const snap = await handlesColRef(currentUser.uid).get();
      const batch = db.batch();
      snap.forEach(doc => batch.delete(doc.ref));
      await batch.commit();
      await refreshList();
    }

    async function importHandles(text) {
      if (!currentUser) return { added: 0, total: cachedList.length };
      const raw = (text || "").split(/[\n,]+/).map(s => normalizeHandle(s)).filter(Boolean);
      const valid = Array.from(new Set(raw.filter(h => HANDLE_RE.test(h))));
      if (valid.length === 0) return { added: 0, total: cachedList.length };

      const batch = db.batch();
      valid.forEach(h => {
        const ref = handlesColRef(currentUser.uid).doc(h);
        batch.set(ref, { handle: h, addedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
      });
      await batch.commit();
      await refreshList();
      return { added: valid.length, total: cachedList.length };
    }

    function exportHandlesCSV() {
      const blob = new Blob([cachedList.join(",")], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "x_saved_accounts.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // --------- QUERY BUILDING ---------
    function normalizeKeywordGroup(raw) {
      if (!raw) return "";
      const parts = raw.split(",").map(s => s.trim()).filter(Boolean);
      if (parts.length === 0) return "";
      const normalized = parts.map(p => {
        const alreadyQuoted = /^["'].*["']$/.test(p);
        if (/\s/.test(p) && !alreadyQuoted) return `"${p}"`;
        return p;
      });
      return normalized.length === 1 ? normalized[0] : `(${normalized.join(" OR ")})`;
    }

    function buildUrl() {
      const username = normalizeHandle($("username").value);
      const start = $("startDate").value;
      const end = $("endDate").value;
      const rawKeywords = $("keywords").value.trim();

      if (!username || !start || !end) {
        alert("Please fill in username, start date, and end date.");
        return null;
      }
      if (end < start) {
        alert("End date must be on or after start date.");
        return null;
      }

      const keywordQuery = normalizeKeywordGroup(rawKeywords);
      const parts = [];
      if (keywordQuery) parts.push(keywordQuery);
      parts.push(`(from:${username})`);
      parts.push(`until:${end}`);
      parts.push(`since:${start}`);

      const query = parts.join(" ");
      const encoded = encodeURIComponent(query);
      return `https://x.com/search?q=${encoded}&src=typed_query`;
    }

    // --------- WIRE UP UI ---------
    window.addEventListener("DOMContentLoaded", () => {
      $("accountSelect").addEventListener("change", (e) => {
        if (e.target.value) $("username").value = e.target.value;
      });
      $("addAccount").addEventListener("click", () => addHandle($("username").value));
      $("removeSelected").addEventListener("click", removeSelected);
      $("clearAll").addEventListener("click", clearAll);

      $("importBtn").addEventListener("click", async () => {
        const text = $("importBox").value;
        const { added, total } = await importHandles(text);
        alert(`Imported ${added} handle(s). Total saved: ${total}.`);
        $("importBox").value = "";
      });

      $("exportBtn").addEventListener("click", exportHandlesCSV);

      $("build").addEventListener("click", () => {
        const url = buildUrl();
        if (!url) return;
        $("result").innerHTML =
          `<div><strong>Generated Link:</strong></div>
           <div style="margin-top:6px;"><a href="${url}" target="_blank" rel="noopener">${url}</a></div>`;
      });
    });
  </script>
</body>
</html>
